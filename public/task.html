<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <script src="/dist/taskManager.js" type="module"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex flex-col">
        <div id="header"></div>
        <main class="flex-1 p-4">
            <header class="bg-blue-600 p-4 text-white">
                <h1 class="text-2xl">Task Manager</h1>
            </header>
            <form id="addTaskForm" class="space-y-4 bg-white p-4 rounded shadow-md mb-6">
                <input id="taskTitle" type="text" placeholder="Task Title" class="w-full p-2 border rounded" required />
                <textarea id="taskDescription" placeholder="Task Description" class="w-full p-2 border rounded" required></textarea>
                <label for="taskPriority">Priorité:</label>
                <select id="taskPriority" name="taskPriority" class="w-full p-2 border rounded">
                    <option value="haute">Haute</option>
                    <option value="moyenne">Moyenne</option>
                    <option value="basse">Basse</option>
                </select>
                <input id="taskDeadline" type="date" class="w-full p-2 border rounded" required />
                <button type="submit" class="w-full bg-green-500 text-white p-2 rounded">Add Task</button>
                <button type="button" id="updateTaskBtn" class="w-full bg-yellow-500 text-white p-2 rounded hidden">Update Task</button>
            </form>
            <div class="bg-white p-4 rounded shadow-md">
                <h2 class="text-xl font-bold mb-4">Liste des Tâches</h2>
                <table class="min-w-full table-auto">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="px-4 py-2">Titre</th>
                            <th class="px-4 py-2">Description</th>
                            <th class="px-4 py-2">Priorité</th>
                            <th class="px-4 py-2">Date Limite</th>
                            <th class="px-4 py-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="taskTableBody">
                        <!-- Les lignes des tâches seront insérées ici -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // Charger le menu de navigation
        window.onload = function() {
            fetch('header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header').innerHTML = data;
                });
        };

        // Fonction pour récupérer les tâches depuis le localStorage
        function getTasks() {
            try {
                return JSON.parse(localStorage.getItem("tasks") || "[]");
            } catch (error) {
                console.error("Erreur lors de la récupération des tâches :", error);
                return [];
            }
        }

        // Fonction pour sauvegarder une tâche dans le localStorage
        function saveTask(task) {
            const tasks = getTasks();
            tasks.push(task);
            localStorage.setItem("tasks", JSON.stringify(tasks));
        }

        // Fonction pour sauvegarder toutes les tâches mises à jour
        function saveAllTasks(tasks) {
            localStorage.setItem("tasks", JSON.stringify(tasks));
        }

        // Fonction pour afficher les tâches dans le tableau
        function displayTasks() {
            const tasks = getTasks();
            const taskTableBody = document.getElementById("taskTableBody");

            // Vider le tableau avant de le remplir
            taskTableBody.innerHTML = "";

            if (tasks.length === 0) {
                taskTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-gray-500">Aucune tâche trouvée.</td>
                    </tr>
                `;
                return;
            }

            // Ajouter chaque tâche dans le tableau
            tasks.forEach((task, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td class="px-4 py-2">${task.title || "Non défini"}</td>
                    <td class="px-4 py-2">${task.description || "Non défini"}</td>
                    <td class="px-4 py-2">${task.priority || "Non défini"}</td>
                    <td class="px-4 py-2">${task.deadline || "Non défini"}</td>
                    <td class="px-4 py-2">
                        <button class="bg-blue-500 text-white px-2 py-1 rounded mr-2" onclick="editTask(${index})">Modifier</button>
                        <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="deleteTask(${index})">Supprimer</button>
                    </td>
                `;
                taskTableBody.appendChild(row);
            });
        }

        // Fonction pour supprimer une tâche
        function deleteTask(index) {
            const tasks = getTasks();
            tasks.splice(index, 1); // Supprimer la tâche à l'index donné
            saveAllTasks(tasks); // Sauvegarder les tâches mises à jour
            displayTasks(); // Mettre à jour l'affichage
        }

        // Fonction pour éditer une tâche
        function editTask(index) {
            const tasks = getTasks();
            const task = tasks[index];

            // Remplir le formulaire avec les données de la tâche
            document.getElementById("taskTitle").value = task.title;
            document.getElementById("taskDescription").value = task.description;
            document.getElementById("taskPriority").value = task.priority;
            document.getElementById("taskDeadline").value = task.deadline;

            // Afficher le bouton de mise à jour et cacher le bouton d'ajout
            document.getElementById("updateTaskBtn").classList.remove("hidden");
            document.getElementById("addTaskForm").querySelector("button[type='submit']").classList.add("hidden");

            // Ajouter un événement au bouton de mise à jour
            document.getElementById("updateTaskBtn").onclick = function() {
                tasks[index] = {
                    title: document.getElementById("taskTitle").value.trim(),
                    description: document.getElementById("taskDescription").value.trim(),
                    priority: document.getElementById("taskPriority").value,
                    deadline: document.getElementById("taskDeadline").value
                };

                saveAllTasks(tasks); // Sauvegarder les tâches mises à jour
                displayTasks(); // Mettre à jour l'affichage

                // Réinitialiser le formulaire et boutons
                document.getElementById("addTaskForm").reset();
                document.getElementById("updateTaskBtn").classList.add("hidden");
                document.getElementById("addTaskForm").querySelector("button[type='submit']").classList.remove("hidden");
            };
        }

        // Gestion du formulaire d'ajout de tâche
        document.getElementById("addTaskForm").addEventListener("submit", function(event) {
            event.preventDefault(); // Empêcher le rechargement de la page

            // Récupérer les valeurs du formulaire
            const title = document.getElementById("taskTitle").value.trim();
            const description = document.getElementById("taskDescription").value.trim();
            const priority = document.getElementById("taskPriority").value;
            const deadline = document.getElementById("taskDeadline").value;

            // Vérification des champs
            if (!title || !description || !deadline) {
                alert("Tous les champs sont obligatoires !");
                return;
            }

            // Créer une nouvelle tâche
            const newTask = {
                title: title,
                description: description,
                priority: priority,
                deadline: deadline
            };

            saveTask(newTask); // Sauvegarder la tâche
            displayTasks(); // Afficher les tâches

            // Réinitialiser le formulaire
            document.getElementById("addTaskForm").reset();
        });

        // Afficher les tâches au chargement de la page
        document.addEventListener("DOMContentLoaded", function() {
            displayTasks();
        });
    </script>
</body>
</html>